<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formulario Medicamento por Voz</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding-bottom: 120px; /* espacio para botones fijos */
    }
    .form-container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2, h3, h4 {
      color: #1c1c1e;
    }
    label {
      font-weight: 500;
      margin-top: 10px;
      display: block;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    .dosage, .presentation {
      background: #f9f9f9;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 12px;
    }
    .error {
      color: red;
      font-size: 14px;
      margin-top: -15px;
      margin-bottom: 15px;
    }
    .footer-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #ddd;
      padding: 15px;
      text-align: center;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: #007aff;
      color: white;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    button.secondary {
      background: #ccc;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Agregar Producto a Inventario</h2>
    <div id="step-container">
      <label for="name">Nombre comercial</label>
      <input type="text" id="name" data-label="Nombre comercial">
      <p class="error hidden" id="error-name">Este campo es obligatorio</p>

      <label for="generic">Nombre gen√©rico</label>
      <input type="text" id="generic" data-label="Nombre gen√©rico">
      <p class="error hidden" id="error-generic">Este campo es obligatorio</p>

      <label for="desc">Descripci√≥n</label>
      <textarea id="desc" rows="3" data-label="Descripci√≥n"></textarea>
      <p class="error hidden" id="error-desc">Este campo es obligatorio</p>

      <div id="dosage-container">
        <div class="dosage">
          <h3>Dosificaci√≥n</h3>
          <label>Concentraci√≥n</label>
          <input type="text" data-label="Concentraci√≥n">
          <label>Forma farmac√©utica</label>
          <input type="text" data-label="Forma farmac√©utica">
        </div>
      </div>
      <button class="secondary" onclick="addDosage()">‚ûï A√±adir dosificaci√≥n</button>

      <div id="presentation-container">
        <div class="presentation">
          <h4>Presentaci√≥n</h4>
          <label>Tipo de unidad</label>
          <input type="text" data-label="Tipo de unidad">
          <label>Cantidad</label>
          <input type="number" data-label="Cantidad">
          <label>Precio ($)</label>
          <input type="number" step="0.01" data-label="Precio">
          <label>Stock disponible</label>
          <input type="number" data-label="Stock disponible">
          <label>C√≥digo de barras</label>
          <input type="text" data-label="C√≥digo de barras">
        </div>
      </div>
      <button class="secondary" onclick="addPresentation()">‚ûï A√±adir presentaci√≥n</button>
    </div>
  </div>

  <div class="footer-buttons">
    <button id="listen-btn">üéôÔ∏è Escuchar voz</button>
    <button id="before-btn">Retroceder</button>
    <button id="prev-btn" class="secondary">‚¨ÖÔ∏è Paso anterior</button>
    <button id="next-btn">Siguiente paso</button>
    <button id="auto-btn">‚ñ∂Ô∏è Iniciar autom√°tico</button>
    <button id="pause-btn" class="hidden">‚è∏Ô∏è Pausar</button>
    <button id="resume-btn" class="hidden">üîÑ Reanudar</button>
    <button id="review-btn" class="secondary">üìã Revisar y guardar</button>
  </div>

  <!-- Modal -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background-color:rgba(0,0,0,0.6); z-index:1000;">
  <div style="background:white; width:90%; max-width:600px; margin:60px auto; padding:20px; border-radius:10px; position:relative;">
    <h3>Resumen del Medicamento</h3>
    <div id="summary-content" style="max-height:400px; overflow:auto; padding:10px;"></div>
    <div style="text-align:right; margin-top:20px;">
      <button onclick="saveToLocal()">üíæ Guardar local</button>
      <button onclick="sendMedicamentos()">üì§ Enviar</button>
      <button onclick="closeModal()" class="secondary">‚ùå Cerrar</button>
    </div>
  </div>
</div>

  <script>
  let allInputs = [];
  let current = 0;
  let autoMode = false;
  let paused = false;

  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'es-ES';
  recognition.continuous = false;
  recognition.interimResults = false;

  // Mayor tolerancia en tiempo de espera antes de cortar
  recognition.maxAlternatives = 1;

  // Palabras clave para parsear
  const replacements = {
    "m√°s": "+",
    "mas": "+",
    "miligramos": "mg",
    "gramos": "g",
    "mililitros": "ml",
    "unidades": "uds"
  };

  function refreshInputs() {
    allInputs = Array.from(document.querySelectorAll('input, textarea')).filter(i => i.dataset.label);
  }

  function parseTranscript(text) {
    let parsed = text.toLowerCase();
    for (const [key, value] of Object.entries(replacements)) {
      const regex = new RegExp(`\\b${key}\\b`, 'gi');
      parsed = parsed.replace(regex, value);
    }
    return parsed.trim();
  }

  function speak(text, callback) {
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'es-ES';
    utter.onend = () => {
      if (typeof callback === 'function') callback();
    };
    synth.speak(utter);
  }

  function updateStep() {
    refreshInputs();
    const input = allInputs[current];
    if (!input) return;
    const label = input.dataset.label;
    speak(`Paso ${current + 1}: ${label}`, () => {
      input.focus();
      if (autoMode && !paused) {
        recognition.start();
      }
    });
  }

  function validateField(input) {
    const value = input.value.trim();
    const error = input.nextElementSibling;
    if (!value && error?.classList?.contains('error')) {
      error.classList.remove('hidden');
      return false;
    }
    if (error?.classList?.contains('error')) {
      error.classList.add('hidden');
    }
    return true;
  }

  function goToNextStep() {
    refreshInputs();
    if (!allInputs[current]) return;

    if (!validateField(allInputs[current])) return;

    current++;
    if (current < allInputs.length) {
      updateStep();
    } else {
      speak("Formulario completo.");
      alert("Formulario completo.");
      current = 0;
      autoMode = false;
    }
  }

  function goToPreviousStep() {
    if (current > 0) {
      current--;
      updateStep();
    } else {
      speak("Est√°s en el primer campo.");
    }
  }

  const removeAccents = (str) => {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }


  recognition.onresult = (event) => {
    let rawText = event.results[0][0].transcript.toLowerCase().trim();

    // Comando especial por voz: agregar presentaci√≥n
    if (rawText.includes("agregar presentaci√≥n") || rawText.includes("nueva presentaci√≥n")) {
      const newInputs = addPresentation();
      refreshInputs();
      // Insertamos los nuevos inputs en el lugar actual
      allInputs.splice(current + 1, 0, ...newInputs);
      speak("Nueva presentaci√≥n agregada. Contin√∫a con tipo de unidad.", () => {
        current++;
        updateStep();
      });
      return;
    }
    const text = removeAccents(rawText);
    const parsed = parseTranscript(text);
    const input = allInputs[current];
    if (input) {
      input.value = parsed;
      goToNextStep();
    }
  };

  /* recognition.onresult = (event) => {
    const input = allInputs[current];
    if (input) {
      const rawText = event.results[0][0].transcript;
      const text = removeAccents(rawText);
      const parsed = parseTranscript(text);
      input.value = parsed;
      goToNextStep();
    }
  }; */

  recognition.onerror = (e) => {
    console.error("Error voz:", e.error);
    speak("Error al usar reconocimiento de voz.");
  };

  document.getElementById('listen-btn').onclick = () => {
    updateStep();
  };

  document.getElementById('next-btn').onclick = () => {
    goToNextStep();
  };

  document.getElementById('prev-btn').onclick = () => {
    goToPreviousStep();
  };

  document.getElementById('auto-btn').onclick = () => {
    autoMode = true;
    paused = false;
    document.getElementById('pause-btn').classList.remove('hidden');
    document.getElementById('resume-btn').classList.add('hidden');
    updateStep();
  };

  document.getElementById('pause-btn').onclick = () => {
    paused = true;
    autoMode = false;
    document.getElementById('pause-btn').classList.add('hidden');
    document.getElementById('resume-btn').classList.remove('hidden');
    speak("Flujo de voz pausado.");
  };

  document.getElementById('resume-btn').onclick = () => {
    paused = false;
    autoMode = true;
    document.getElementById('pause-btn').classList.remove('hidden');
    document.getElementById('resume-btn').classList.add('hidden');
    updateStep();
  };

  function addDosage() {
    const div = document.createElement('div');
    div.className = 'dosage';
    div.innerHTML = `
      <h3>Dosificaci√≥n</h3>
      <label>Concentraci√≥n</label>
      <input type="text" data-label="Concentraci√≥n">
      <label>Forma farmac√©utica</label>
      <input type="text" data-label="Forma farmac√©utica">
    `;
    document.getElementById('dosage-container').appendChild(div);
    refreshInputs();
  }

  function addPresentation() {
  const div = document.createElement('div');
  div.className = 'presentation';
  div.innerHTML = `
    <h4>Presentaci√≥n</h4>
    <label>Tipo de unidad</label>
    <input type="text" data-label="Tipo de unidad">
    <label>Cantidad</label>
    <input type="number" data-label="Cantidad">
    <label>Precio ($)</label>
    <input type="number" step="0.01" data-label="Precio">
    <label>Stock disponible</label>
    <input type="number" data-label="Stock disponible">
    <label>C√≥digo de barras</label>
    <input type="text" data-label="C√≥digo de barras">
  `;
  document.getElementById('presentation-container').appendChild(div);

  // Devuelve los nuevos inputs para incluirlos en la lista
  return Array.from(div.querySelectorAll('input')).filter(i => i.dataset.label);
}


  refreshInputs();

  const medicamentos = [];

document.getElementById('review-btn').onclick = () => {
  const data = collectFormData();
  showSummary(data);
};

function collectFormData() {
  refreshInputs();
  const data = {};
  allInputs.forEach(input => {
    const label = input.dataset.label;
    if (label) {
      if (!data[label]) {
        data[label] = input.value.trim();
      } else {
        // Si hay repetidos (ej. m√∫ltiples concentraciones), los guardamos como array
        if (!Array.isArray(data[label])) data[label] = [data[label]];
        data[label].push(input.value.trim());
      }
    }
  });
  return data;
}

function showSummary(data) {
  const content = document.getElementById('summary-content');
  content.innerHTML = '';

  for (const key in data) {
    const val = Array.isArray(data[key]) ? data[key].join(', ') : data[key];
    const line = document.createElement('p');
    line.innerHTML = `<strong>${key}:</strong> ${val}`;
    content.appendChild(line);
  }

  document.getElementById('modal').style.display = 'block';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function saveToLocal() {
  const data = collectFormData();
  medicamentos.push(data);
  localStorage.setItem('medicamentos', JSON.stringify(medicamentos));
  alert('Medicamento guardado localmente.');
  closeModal();
}

function sendMedicamentos() {
  const saved = localStorage.getItem('medicamentos');
  const parsed = saved ? JSON.parse(saved) : [];

  // Simulaci√≥n de env√≠o
  console.log("üì§ Enviando medicamentos...", parsed);

  alert(`Se enviaron ${parsed.length} medicamentos (simulado).`);

  // Aqu√≠ podr√≠as hacer una petici√≥n real:
  // fetch('/api/medicamentos', { method: 'POST', body: JSON.stringify(parsed) })

  closeModal();
}
 
</script>

</body>
</html>
